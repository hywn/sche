<script src="louscurl.js"></script>
<script src="schedule.js"></script>
<script src="canvasschedule.js"></script>

<div id="scheduleBox" class="box"><div id="sbInner"><canvas id="schedule"></div></div>

<div id="geninfo" class="box">
	<textarea placeholder="enter class codes (e.g. 10038) separated by whitespace; shift+enter to generate schedule"id="classesToAdd"></textarea>
	<textarea placeholder="some output will appear here" id="output"></textarea>
</div>

<style>
body {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	align-items: center;
	flex-direction: row-reverse
}

.box { background-color: #eee; padding: 1em; margin: 1em }
	
#sbInner { background-color: #fff; padding: 1em }
#scheduleBox { display: inline-block }

#geninfo { width:400px }
textarea { width: 100%; height: 12em; resize: none }
</style>

<script>
const KEY = 'uva_schedule'
const CLASS_INPUT = document.querySelector("#classesToAdd")
const SCHEDULE_DISPLAY = new ScheduleCanvas("schedule", {background: "#fff"});

/// saves past work in local storage
function save(work)
{
	window.localStorage.setItem(KEY, JSON.stringify(work))
}

/// gets past work in local storage
function load()
{
	let loaded = JSON.parse(window.localStorage.getItem(KEY))
	return loaded? loaded : ''
}

CLASS_INPUT.addEventListener('keydown', e => {
	if (!(e.shiftKey && e.key === 'Enter')) return
	
	save(CLASS_INPUT.value)
	gen()
	
	e.preventDefault()
})

const url = new URL(window.location.href);
const srcurl = url.searchParams.get("src");

// loads schedule data from 1. URL or 2. local storage
if (srcurl) {
	fetch(srcurl)
		.then(resp => resp.text())
		.then(text => {
			CLASS_INPUT.value = text
			addClasses()
		})
} else {
	CLASS_INPUT.value = load()
}

String.prototype.scanz = function(regex) {
	return Array.from(this.matchAll(regex)).map(groups => groups[0])
}

function gen()
{	
	const classes = CLASS_INPUT.value
		.replace(/#.+/g, '') // remove comments
		.scanz(/\d+/g)       // extract codes
	
	promiseSchedule(classes, sched => {
		SCHEDULE_DISPLAY.drawScheduleCallback(sched)
		document.querySelector('#output').value = getTextSchedule(sched)
	});
}

gen()
</script>