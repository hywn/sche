<script src="louscurl.js"></script>
<script src="schedule.js"></script>
<script src="canvasschedule.js"></script>

<div id="scheduleBox" class="box"><div id="sbInner"><canvas id="schedule"></div></div>

<div id="geninfo" class="box">
	<textarea id="editor" placeholder="editor window"></textarea>
	<textarea id="output" placeholder="output window"></textarea>
</div>

<style>
body {
	display: flex;
	flex-wrap: wrap;
	justify-content: center;
	align-items: center;
	flex-direction: row-reverse
}

.box { background-color: #eee; padding: 1em; margin: 1em }

#sbInner { background-color: #fff; padding: 1em }
#scheduleBox { display: inline-block }

#geninfo { width:400px }
textarea { width: 100%; resize: none }
#editor { height: 24em }
#output { height: 12em }
</style>

<script>
const EDITOR = document.querySelector('#editor')
const OUTPUT = document.querySelector('#output')

const KEY = 'uva_schedule'
const SCHEDULE_DISPLAY = new ScheduleCanvas('schedule', {background: '#fff'})

/// gets past work in local storage
function load()
{
	const loaded = window.localStorage.getItem(KEY)
	return loaded? loaded : '# enter class codes separated by whitespace\n# use #s for comments\n# press ctrl+s to save/draw schedule\n\n12345 # some class\n23456 # some other class\n\n# other classes:\n34567 45678 56789'
}

/// editor keylistener (saves work in local storage)
EDITOR.addEventListener('keydown', e => {
	if (!(e.ctrlKey && e.key === 's')) return

	window.localStorage.setItem(KEY, EDITOR.value)
	gen()

	e.preventDefault()
})

/// displays canvas schedule; outputs output
function gen()
{
	const classes = EDITOR.value
		.replace(/#.*/g, '') // remove comments
		.match(/\d+/g)       // extract codes

	OUTPUT.value = 'loading...'

	promiseSchedule(classes).then(sched => {
		SCHEDULE_DISPLAY.drawScheduleCallback(sched)
		OUTPUT.value = getTextSchedule(sched)
	})
}

// loads schedule data from 1. URL or 2. local storage
const srcurl = new URL(window.location.href).searchParams.get("src")
if (srcurl) {
	fetch(srcurl)
		.then(resp => resp.text())
		.then(text => {
			EDITOR.value = text
			gen()
		})
} else {
	EDITOR.value = load()
	gen()
}
</script>