<div id="burrito">
	<div id="time">time</div>
	<div id="message">message</div>
</div>

<style>
body { display: flex; justify-content: center; align-items: center; font-size: 2em }
#burrito { width: 12em; padding: 2em }
</style>

<script src="schedule.js"></script>

<script>
const TIME    = document.querySelector('#time')
const MESSAGE = document.querySelector('#message')
const BURRITO = document.querySelector('#burrito')

const cWARNING = 'ffff6e'
const cOK = '3ce85c'
const cINPROGRESS = 'f5364f'

let today_items = []

function createClock(schedule)
{
	const curr_dow = new Date().getDay()

	today_items = schedule
		.filter(item => item.dows.includes(curr_dow))
		.sort((a, b) => a.start - b.end)

	update()
	setInterval(update, 1000)
}

function update()
{
	const today = new Date()

	TIME.innerHTML = `${pad(today.getHours())}:${pad(today.getMinutes())}:${pad(today.getSeconds())}`

	let now = today.getHours() + today.getMinutes()/60 + today.getSeconds()/60/60; // hrt

	const curr_item = today_items
		.find(i => i.start <= now && now < i.end)

	const next_item = today_items
		.find(i => i.start > now)

	const last_item = today_items
		.reverse()
		.find(i => i.end < now)

	let msg = '';

	if (curr_item != null) {
		msg = `you get out in ${Math.round(60 * (curr_item.end - now))} minutes`
		set_gradient (now, curr_item.start, curr_item.end, cINPROGRESS, cOK)
	}

	if (next_item != null) {
		let until_hrt = next_item.start - now;
		let hours = Math.floor(until_hrt)
		let minutes = Math.round(60 * (until_hrt - hours))
		msg += `\nyour next item is in ${hours? `${hours} hours and `:''}${minutes} minutes at ${next_item.loc}`

		if (curr_item == null) {
			if (until_hrt < 0.25)
				set_gradient (now, next_item.start - 0.25, next_item.start, cWARNING, cINPROGRESS)
			else if (until_hrt < 0.5)
				set_gradient (now, next_item.start - 0.5, next_item.start - 0.25, cOK, cWARNING)
			else
				BURRITO.style.backgroundColor = '#' + cOK
		}
	}

	if(msg === '')
		msg = 'done for the day'

	MESSAGE.innerHTML = msg.trim()
}

function set_gradient(now, start, end, starthex, endhex)
{
	let total = end - start
	let remaining = end - now
	BURRITO.style.backgroundColor = '#' + get_gradient(1 - remaining/total, starthex, endhex)
}

function get_gradient(percent, start_hex, end_hex)
{
	let startvals = get_three_hex(start_hex)
	let endvals = get_three_hex(end_hex)

	let gradient = '';

	for (i in startvals)
		gradient += Math.round((startvals[i] + percent * (endvals[i] - startvals[i]))).toString(16)

	return gradient
}

function get_three_hex(hexstr) { return hexstr.split(/(?=(?:..)*$)/).map(num => parseInt('0x' + num)) }
function pad (myint) { return myint.toString().padStart(2, '0') }

const KEY = 'schedule_clock'

// loads schedule data from 1. URL or 2. local storage
const src_url = new URLSearchParams(window.location.search).get('src')

;(async function() {

	const schedule =
		src_url ? await fetch(src_url)
		                .then(r => r.text())
		                .then(text => text.replace(/#.*/g, '').replace(/^!.+/mg, ''))
		                .then(stripped => parseSchedule(stripped))
		                .finally(json => window.localStorage.setItem(KEY, JSON.stringify(json)))
		        : JSON.parse(window.localStorage.getItem(KEY) || '[]')

	createClock(schedule)

})();
</script>