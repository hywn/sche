<script src="schedule.js"></script>
<script src="canvasschedule.js"></script>

<div id="scheduleBox" class="box">
	<div id="sbInner">
		<canvas id="scheduleCanvas">
	</div>
</div>

<div id="geninfo" class="box">
	<textarea id="editor"></textarea>
</div>

<style>
body { display: flex;
       flex-wrap: wrap;
       justify-content: center;
       align-items: center;
       flex-direction: row-reverse }

.box { background-color: #eee; padding: 1em; margin: 1em }

#scheduleBox { display: inline-block }

#geninfo { width:400px }
#editor { width: 100%; height: 36em; white-space: nowrap }
</style>

<script>
const EDITOR = document.querySelector('#editor')
const KEY    = 'regular_schedule'
const TUTORIAL = `# enter your schedule in the following format:
#
# day(s) of the week
# time-time some event
# time-time some other event
#
# some examples:

mo we fr
08:15-09:30 eat breakfast
12:30-13:40 eat lunch

tuth
8:30 - 9:45   eat special breakfast
12pm - 2:50pm eat lunch

fr
0950 - 1030 brunch

# use #s for comments
# use !s to set settings like so:

!background #fof
!font 14px Comic Sans MS

# you only need to set those you wish to override.
# generate a list of all settings with !default:

!default

# press ctrl+s to save/generate your schedule
# delete everything and reload the page to see this tutorial text again`

/// gets default settings nicely padded
function get_default_settings_text()
{
	const spacing = Math.max(...Object.keys(default_settings).map(key => key.length))
	return Object.entries(default_settings)
		.map(entry => `!${(entry[0]).padEnd(spacing)} ${entry[1]}`)
		.join('\n')
}

/// generates schedule
function gen()
{
	EDITOR.value = EDITOR.value.replace(/^!default$/mg, get_default_settings_text())

	const settings = {...default_settings}
	
	Array.from(EDITOR.value.matchAll(/!(\w+)\s+(.+)/g))
		.filter(groups => groups[1] in settings)
		.forEach(groups => {
			settings[groups[1]] =
				typeof settings[groups[1]] === 'number'?
					Number(groups[2])
					: groups[2]
		})
	
	s = new ScheduleCanvas('scheduleCanvas', settings)
	
	document.querySelector("#sbInner").style.backgroundColor = s.background
	
	// note: temporary workaround?
	s.drawSchedule(EDITOR.value.replace(/#.*/g, '').replace(/^!.+/mg, '').trim())
}

/// editor keylistener (saves work in local storage)
EDITOR.addEventListener('keydown', e => {
	if (!(e.ctrlKey && e.key === 's')) return
	
	window.localStorage.setItem(KEY, EDITOR.value)
	gen()
	
	e.preventDefault()
})

/// gets past work in local storage
function load()
{
	const loaded = window.localStorage.getItem(KEY)
	return loaded? loaded : TUTORIAL

}

// loads schedule data from 1. URL or 2. local storage
const srcurl = new URL(window.location.href).searchParams.get("src")
if (srcurl) {
	fetch(srcurl)
		.then(resp => resp.text())
		.then(text => {
			EDITOR.value = text
			gen()
		})
} else {
	EDITOR.value = load()
	gen()
}
</script>